<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Megabonk Leaderboard</title>
  <style>
    :root {
      --bg: #0b0d10; --panel:#12151a; --muted:#8b9bb4; --text:#e6edf3; --accent:#ffd166; --ring:#000; --row:#0f1318;
      --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    * { box-sizing: border-box; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--text); font: 14px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    a { color: #7cc7ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; gap:16px; align-items:center; justify-content: space-between; margin-bottom: 16px; }
    h1 { font-size: 20px; margin:0; letter-spacing:.2px; }
    .controls { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    .control { background: var(--panel); border:1px solid #1f2530; border-radius:10px; padding:8px 10px; display:flex; gap:8px; align-items:center; }
    .control label { color: var(--muted); font-size: 12px; }
    select, input[type="search"] { appearance:none; background:#0f1318; color:var(--text); border:1px solid #1f2530; border-radius:8px; padding:8px 10px; min-width: 180px; }
    .pill { display:inline-flex; align-items:center; gap:6px; background:#0f1318; border:1px solid #1f2530; border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted); }

    .panel { background: var(--panel); border:1px solid #1f2530; border-radius: 14px; overflow: clip; }
    .table-wrap { overflow:auto; max-height: calc(100vh - 195px); }

    table { width:100%; border-collapse: separate; border-spacing: 0; }
    thead th { position: sticky; top:0; background: #0f1318; color:#b9c6d2; z-index:2; text-align: left; font-weight:600; font-size:12px; text-transform: uppercase; letter-spacing:.08em; border-bottom:1px solid #1f2530; padding:10px 12px; }
    tbody td { border-bottom:1px solid #151c24; padding:12px; vertical-align: top; }
    tbody tr:nth-child(even) { background: #0d1117; }
    tbody tr:hover { background: #0f141b; }
    .rank { font-weight:700; width:64px; }
    .kills { font-variant-numeric: tabular-nums; text-align:right; width:140px; }
    .player { display:flex; align-items:center; gap:10px; }
    .flag { font-size:18px; width: 1.2em; text-align:center; opacity:.9 }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#19202a; border:1px solid #223044; color:#a9bbd2; font-size:11px; }
    .btn { cursor:pointer; background:#0f1318; color:var(--text); border:1px solid #243043; border-radius: 9px; padding:6px 10px; }
    .btn:hover { border-color:#2f3f58; }
    .btn-ghost { background: transparent; border-color: #2a3547; }
    .btn-small { padding: 4px 8px; font-size: 12px; }

    .details { background: #0b1016; border-top: 1px dashed #1f2a3a; }
    .stack { display:flex; flex-wrap: wrap; gap:6px; }

    .empty { color: var(--muted); text-align:center; padding: 28px 12px; }
    .foot { display:flex; justify-content: space-between; align-items:center; color:var(--muted); padding:10px 12px; font-size:12px; border-top:1px solid #1f2530; background:#0f1318; }

    .loading { display:flex; align-items:center; gap:10px; color: var(--muted); padding: 16px; }
    .dot { width:6px; height:6px; border-radius:50%; background: var(--muted); opacity:.5; animation: blink 1.2s infinite ease-in-out; }
    .dot:nth-child(2){ animation-delay:.15s } .dot:nth-child(3){ animation-delay:.3s }
    @keyframes blink{ 0%,100%{ opacity:.25 } 50%{ opacity:1 } }

    @media (max-width: 700px) {
      .kills { width:auto; }
      .controls { gap:6px; }
      select, input[type="search"] { min-width: unset; width: 100%; }
      header { flex-direction: column; align-items: stretch; gap: 12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Megabonk Leaderboard</h1>
      <div class="controls">
        <div class="control">
          <label for="patch">补丁</label>
          <select id="patch"></select>
        </div>
        <div class="control">
          <label for="q">搜索</label>
          <input id="q" type="search" placeholder="玩家 / 角色 / 国家代码…" />
        </div>
        <div class="control">
          <label for="character">角色</label>
          <select id="character">
            <option value="">全部</option>
          </select>
        </div>
        <button id="refresh" class="btn">刷新</button>
      </div>
    </header>

    <div class="panel">
      <div id="meta" class="foot" style="border-bottom:1px solid #1f2530;">
        <span class="pill">数据源：<code class="mono" id="sourceName">(未加载)</code></span>
        <span>总计 <b id="count">0</b> 条 · 上次更新 <span id="updated">-</span></span>
      </div>
      <div class="table-wrap" id="wrap">
        <div class="loading" id="loading" hidden>
          <span>正在加载</span>
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
        <table id="grid" aria-label="Leaderboard">
          <thead>
            <tr>
              <th class="rank">名次</th>
              <th>玩家</th>
              <th>角色</th>
              <th class="kills" data-sort="kills">击杀 ▾</th>
              <th>视频</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="5" class="empty">尚无数据</td></tr>
          </tbody>
        </table>
      </div>
      <div class="foot">
        <div>数据文件位于 <code class="mono">/data/leaderboard-&lt;patch&gt;.json</code>（优先）或 <code class="mono">.csv</code></div>
        <div>
          <a id="dlJson" href="#">下载 JSON</a>
          ·
          <a id="dlCsv" href="#">下载 CSV</a>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ======================= 配置区 =======================
   * 将本文件放在你的仓库（例如 /leaderboard/index.html）
   * 在 /data 目录放置数据文件：leaderboard-<补丁>.json（或 .csv）
   * 需要新增补丁：只在 PATCHES 中追加版本号，并新增对应数据文件即可。
   */
  // 自动推断 GitHub Pages 的 /<repo>/ 前缀，返回  /<repo>/data/ ；
// 自定义域名时返回 /data/
function guessDataDir(){
  const segs = location.pathname.split('/').filter(Boolean);
  // project pages: https://user.github.io/<repo>/...
  const repo = segs.length ? `/${segs[0]}/` : '/';
  const candidates = [ `${repo}data/`, '/data/', 'data/' ];
  return candidates[0]; // 首选 /<repo>/data/
}

const CONFIG = {
    dataDir: guessDataDir(),
    PATCHES: ['1.0.17'],     // ← 在这里加入新的补丁版本，例如 '1.0.18'
    defaultPatch: '1.0.17',
    prefer: 'json'           // 优先使用 json；若 404 则自动尝试 csv
  };

  // ===== 小工具 =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmt = n => (typeof n === 'number' ? n.toLocaleString() : n);
  const escapeHtml = s => (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  function countryFlag(cc) {
    if (!cc || cc.length !== 2) return '🏳️';
    const A = 127397; // regional indicator base
    return String.fromCodePoint(...cc.toUpperCase().split('').map(ch => ch.charCodeAt(0) + A));
  }

  // 轻量 CSV 解析（支持引号和逗号）
  function parseCSV(text) {
    const lines = text.trim().split(/
?
/);
    const header = lines.shift().split(',').map(s=>s.trim());
    return lines.map(line=>{
      const cols = line.split(',').map(s=>s.trim());
      const obj = {};
      header.forEach((h,i)=>obj[h]=cols[i]||'');
      // 类型转换
      obj.rank = Number(obj.rank||0);
      obj.kills = Number(obj.kills||0);
      obj.weapons = (obj.weapons||'').split(';').filter(Boolean);
      obj.tomes   = (obj.tomes||'').split(';').filter(Boolean);
      obj.items   = (obj.items||'').split(';').filter(Boolean);
      return obj;
    });
  }

  // 兼容多种 JSON 形态：数组 或 {data|rows|leaderboard|results:[...]}
  function coerceRows(input, patch){
    if (Array.isArray(input)) return input;
    const keys = ['data','rows','leaderboard','results','list'];
    for (const k of keys){
      if (Array.isArray(input?.[k])) return input[k];
    }
    // 单对象也允许（至少要包含必要字段）
    if (input && typeof input === 'object' && 'player' in input){
      return [input];
    }
    console.warn('无法从 JSON 中解析出数组，返回空集');
    return [];
  }

  async function fetchData(patch) {
    const base = CONFIG.dataDir + `leaderboard-${patch}`;
    const tryJson = async () => {
      const base = CONFIG.dataDir + `leaderboard-${patch}`;
      const res = await fetch(base + '.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('json:'+res.status);
      const raw = await res.json();
      const data = coerceRows(raw, patch);
      return { kind:'json', data };
    };
    const tryCsv = async () => {
      const res = await fetch(base + '.csv', { cache: 'no-store' });
      if (!res.ok) throw new Error('csv:'+res.status);
      const text = await res.text();
      const rows = parseCSV(text);
      // 尝试把 CSV 的 list 字段拆分；允许分号分隔
      const normalize = (v) => (v==null||v==='') ? [] : String(v).split(';').map(s=>s.trim()).filter(Boolean);
      const data = rows.map(r => ({
        rank: +r.rank || null,
        player: r.player || '',
        character: r.character || '',
        kills: +r.kills || 0,
        country_code: r.country_code || '',
        video_url: r.video_url || '',
        patch: r.patch || patch,
        weapons: normalize(r.weapons),
        tomes: normalize(r.tomes),
        items: normalize(r.items),
        created_at_iso: r.created_at_iso || '',
        updated_at_iso: r.updated_at_iso || '',
        notes: r.notes || ''
      }));
      return { kind:'csv', data };
    };
    const order = CONFIG.prefer === 'json' ? [tryJson, tryCsv] : [tryCsv, tryJson];
    let err; for (const fn of order) { try { return await fn(); } catch(e){ err=e; } }
    throw err;
  }

  function uniqueCharacters(rows){
    const s = new Set(rows.map(r => r.character).filter(Boolean));
    return [''].concat([...s].sort());
  }

  function renderCharacterOptions(list){
    const sel = $('#character');
    sel.innerHTML = '<option value="">全部</option>' + list.filter(Boolean).map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
  }

  function applyFilters(rows) {
    const q = $('#q').value.trim().toLowerCase();
    const char = $('#character').value;
    let out = rows;
    if (q) {
      out = out.filter(r =>
        (r.player && r.player.toLowerCase().includes(q)) ||
        (r.character && r.character.toLowerCase().includes(q)) ||
        (r.country_code && r.country_code.toLowerCase().includes(q))
      );
    }
    if (char) out = out.filter(r => r.character === char);
    return out;
  }

  function mostRecentUpdatedISO(rows){
    const t = rows.map(r => Date.parse(r.updated_at_iso||r.created_at_iso||0)).filter(n=>!isNaN(n));
    if (!t.length) return '-';
    const d = new Date(Math.max(...t));
    return d.toLocaleString();
  }

  function renderTable(rows) {
    const tbody = $('#rows');
    if (!rows.length) { tbody.innerHTML = '<tr><td colspan="5" class="empty">没有匹配的结果</td></tr>'; return; }
    const html = rows.map((r, i) => {
      const flag = countryFlag(r.country_code||'');
      const video = r.video_url ? `<a href="${escapeHtml(r.video_url)}" target="_blank" rel="noopener">打开</a>` : '<span style="color:var(--muted)">无</span>';
      const detailsId = `det_${i}`;
      const itemsPreview = (r.items||[]).slice(0,6).join(', ');
      return `
        <tr class="row" data-i="${i}">
          <td class="rank">${r.rank ?? ''}</td>
          <td class="player"><span class="flag" title="${escapeHtml(r.country_code||'')}">${flag}</span><span>${escapeHtml(r.player||'')}</span></td>
          <td>${escapeHtml(r.character||'')}</td>
          <td class="kills mono" title="Items: ${escapeHtml(itemsPreview)}">${fmt(r.kills)}</td>
          <td>
            ${video}
            <button class="btn btn-ghost btn-small" data-toggle="${detailsId}">详情</button>
          </td>
        </tr>
        <tr class="details" id="${detailsId}" hidden>
          <td colspan="5">
            <div style="display:flex; gap:18px; flex-wrap:wrap;">
              <div><div class="badge">Weapons</div><div class="stack" style="margin-top:8px;">${(r.weapons||[]).map(x=>`<span class="badge">${escapeHtml(x)}</span>`).join('') || '<span class="pill">—</span>'}</div></div>
              <div><div class="badge">Tomes</div><div class="stack" style="margin-top:8px;">${(r.tomes||[]).map(x=>`<span class="badge">${escapeHtml(x)}</span>`).join('') || '<span class="pill">—</span>'}</div></div>
              <div style="min-width:260px;"><div class="badge">Items</div><div class="stack" style="margin-top:8px; max-height:110px; overflow:auto;">${(r.items||[]).map(x=>`<span class="badge">${escapeHtml(x)}</span>`).join('') || '<span class="pill">—</span>'}</div></div>
            </div>
          </td>
        </tr>`;
    }).join('');
    tbody.innerHTML = html;
    $$('button[data-toggle]').forEach(btn => btn.addEventListener('click', e => {
      const id = e.currentTarget.getAttribute('data-toggle');
      const row = document.getElementById(id);
      row.hidden = !row.hidden;
      e.currentTarget.textContent = row.hidden ? '详情' : '收起';
    }));
  }

  // ===== 主流程 =====
  const state = { raw: [], view: [], patch: CONFIG.defaultPatch, sourceKind: '' };

  function populatePatchOptions() {
    const sel = $('#patch');
    sel.innerHTML = CONFIG.PATCHES.map(p => `<option ${p===CONFIG.defaultPatch?'selected':''}>${p}</option>`).join('');
  }

  async function loadAndRender(patch){
    $('#loading').hidden = false; $('#rows').innerHTML = '';
    try {
      const { kind, data } = await fetchData(patch);
      state.raw = Array.isArray(data) ? data.slice() : [];
      // 排序：kills 降序，rank（如有）升序
      state.raw.sort((a,b)=> (b.kills||0) - (a.kills||0) || (a.rank||999999) - (b.rank||999999));
      state.sourceKind = kind;
      $('#sourceName').textContent = `leaderboard-${patch}.${kind}`;
      $('#dlJson').href = CONFIG.dataDir + `leaderboard-${patch}.json`;
      $('#dlCsv').href  = CONFIG.dataDir + `leaderboard-${patch}.csv`;
      renderCharacterOptions(uniqueCharacters(state.raw));
      state.view = applyFilters(state.raw);
      renderTable(state.view);
      $('#count').textContent = state.view.length;
      $('#updated').textContent = mostRecentUpdatedISO(state.raw);
    } catch (err) {
      $('#rows').innerHTML = `<tr><td colspan="5" class="empty">加载失败：${escapeHtml(err+'' )}<br>请检查 <code class=mono>/data/leaderboard-${patch}.json</code> 或 <code class=mono>.csv</code> 文件是否存在</td></tr>`;
      $('#count').textContent = '0';
      $('#updated').textContent = '-';
      $('#sourceName').textContent = '(未找到)';
    } finally {
      $('#loading').hidden = true;
    }
  }

  // 事件 & 初始化
  document.addEventListener('DOMContentLoaded', () => {
    populatePatchOptions();
    $('#patch').addEventListener('change', e => loadAndRender(e.target.value));
    $('#q').addEventListener('input', () => { state.view = applyFilters(state.raw); renderTable(state.view); $('#count').textContent = state.view.length; });
    $('#character').addEventListener('change', () => { state.view = applyFilters(state.raw); renderTable(state.view); $('#count').textContent = state.view.length; });
    $('#refresh').addEventListener('click', () => loadAndRender($('#patch').value));
    loadAndRender(CONFIG.defaultPatch);
  });
  </script>
</body>
</html>
