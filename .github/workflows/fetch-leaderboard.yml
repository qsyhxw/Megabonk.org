name: Fetch Megabonk Leaderboard

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  fetch-leaderboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing Python packages..."
        pip install requests brotli
        echo "âœ… Packages installed:"
        pip list | grep -E "(requests|[Bb]rotli)"
    
    - name: Fetch leaderboard data
      run: |
        python << 'EOF'
        import requests
        import json
        import brotli
        import time
        from datetime import datetime
        from pathlib import Path

        API_URL = 'https://megabonk.fun/api/leaderboard'

        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'application/json, text/plain, */*',
            'Accept-Language': 'en-US,en;q=0.9',
            'Referer': 'https://megabonk.fun/',
            'Origin': 'https://megabonk.fun',
            'Connection': 'keep-alive'
        }

        print('ğŸ“¡ Fetching data from megabonk.fun...')
        print(f'ğŸ”§ Brotli available: {brotli is not None}')
        
        max_retries = 3
        for attempt in range(max_retries):
            try:
                if attempt > 0:
                    wait_time = attempt * 2
                    print(f'â³ Waiting {wait_time}s before retry...')
                    time.sleep(wait_time)
                
                response = requests.get(
                    API_URL,
                    headers=headers,
                    timeout=30,
                    allow_redirects=True
                )
                
                print(f'ğŸ“Š Response status: {response.status_code}')
                print(f'ğŸ“¦ Content-Encoding: {response.headers.get("Content-Encoding")}')
                print(f'ğŸ“ Content length: {len(response.content)} bytes')
                
                response.raise_for_status()
                
                # Manual Brotli decompression if needed
                content_encoding = response.headers.get('Content-Encoding', '').lower()
                
                if content_encoding == 'br':
                    print('ğŸ”“ Manually decompressing Brotli data...')
                    try:
                        decompressed = brotli.decompress(response.content)
                        print(f'âœ… Decompressed: {len(decompressed)} bytes')
                        data = json.loads(decompressed.decode('utf-8'))
                    except Exception as e:
                        print(f'âŒ Brotli decompression failed: {e}')
                        raise
                else:
                    # Try normal JSON parsing
                    print('ğŸ“„ Using normal JSON parsing...')
                    data = response.json()
                
                print(f'âœ… Successfully parsed {len(data)} entries')
                
                # Create output directory
                output_dir = Path('data')
                output_dir.mkdir(exist_ok=True)
                
                # Build complete data structure
                output = {
                    'source': 'megabonk.fun',
                    'source_url': API_URL,
                    'fetched_at': datetime.utcnow().isoformat() + 'Z',
                    'count': len(data),
                    'data': data
                }
                
                # Save main file
                with open('data/leaderboard.json', 'w', encoding='utf-8') as f:
                    json.dump(output, f, ensure_ascii=False, indent=2)
                
                # Save minified version
                with open('data/leaderboard.min.json', 'w', encoding='utf-8') as f:
                    json.dump(output, f, ensure_ascii=False, separators=(',', ':'))
                
                print('ğŸ’¾ Data saved successfully')
                print(f'ğŸ“Š Total entries: {len(data)}')
                
                if len(data) > 0:
                    first_entry = data[0]
                    print(f'ğŸ¥‡ First entry: {first_entry}')
                    
                    # Try to find player name field
                    player_name = (first_entry.get('name') or 
                                 first_entry.get('player') or 
                                 first_entry.get('username') or 
                                 'Unknown')
                    score = (first_entry.get('kills') or 
                           first_entry.get('score') or 
                           first_entry.get('points') or 0)
                    print(f'ğŸ‘¤ Top player: {player_name} - {score:,}')
                
                # Success - exit the retry loop
                break
                
            except requests.exceptions.RequestException as e:
                print(f'âŒ Request error on attempt {attempt + 1}/{max_retries}: {e}')
                if attempt == max_retries - 1:
                    raise
            except json.JSONDecodeError as e:
                print(f'âŒ JSON decode error on attempt {attempt + 1}/{max_retries}: {e}')
                print(f'ğŸ“ Response text (first 500 chars): {response.text[:500]}')
                if attempt == max_retries - 1:
                    raise
            except Exception as e:
                print(f'âŒ Unexpected error on attempt {attempt + 1}/{max_retries}: {type(e).__name__}: {e}')
                if attempt == max_retries - 1:
                    raise
        
        print('âœ¨ Fetch completed successfully')
        EOF
    
    - name: Commit data to repository
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add data/leaderboard.json data/leaderboard.min.json
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes in data, skipping commit"
        else
          git commit -m "ğŸ¤– Update leaderboard $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "âœ… Data updated and pushed to repository"
        fi
    
    - name: Display summary
      run: |
        echo "==================================================="
        echo "âœ… Leaderboard fetch completed"
        echo "ğŸ“… Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ“ Data location: data/leaderboard.json"
        echo "==================================================="
