name: Build aliases & generate sitemap

on:
  push:
    branches: [ main ]        # å¦‚ä¸»åˆ†æ”¯ä¸æ˜¯ mainï¼Œè¯·æ”¹è¿™é‡Œ
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * 1"      # æ¯å‘¨ä¸€ 03:17 UTC è‡ªåŠ¨åˆ·æ–°ï¼ˆå¯åˆ é™¤ï¼‰

permissions:
  contents: write              # å…è®¸å·¥ä½œæµå‘ä»“åº“æ¨é€

concurrency:
  group: autoupdate-sitemap
  cancel-in-progress: true     # é¿å…å¹¶å‘ä¿®æ”¹ç›¸äº’å†²çª

jobs:
  sitemap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main with full history
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: true

      # å¯é€‰ï¼šè‹¥ä½ çš„æŸäº›é¡µé¢æ˜¯ *.html æ–‡ä»¶ï¼ˆæ¯”å¦‚ database/weapons/aegis.htmlï¼‰ï¼Œ
      # ä¸‹é¢è¿™æ­¥ä¼šä¸ºå®ƒä»¬åˆ›å»ºâ€œç›®å½•åˆ«åâ€ï¼šdatabase/weapons/aegis/index.htmlï¼Œ
      # è¿™æ · https://megabonk.org/database/weapons/aegis/ ä¹Ÿèƒ½ 200ã€‚
      # å·²ç»æ˜¯ç›®å½•ç»“æ„ï¼ˆâ€¦/index.htmlï¼‰çš„è·¯å¾„ä¸ä¼šå—å½±å“ã€‚
      - name: Create extensionless aliases for database/*
        run: |
          set -euxo pipefail
          shopt -s globstar nullglob
          # ä»…å¤„ç† database/ ä¸‹çš„ *.htmlï¼Œé¿å…å½±å“ guides/ ç­‰å·²æ˜¯ç›®å½•ç»“æ„çš„é¡µé¢
          for f in database/**/*.html; do
            base="$(basename "$f")"
            # è·³è¿‡ç›®å½•é¦–é¡µå’Œé€šç”¨ 404
            if [ "$base" = "index.html" ] || [ "$base" = "404.html" ]; then
              continue
            fi
            dir="${f%.html}"
            mkdir -p "$dir"
            cp -f "$f" "$dir/index.html"
          done

      - name: Generate sitemap.xml (extensionless URLs)
        uses: cicirello/generate-sitemap@v1
        with:
          base-url-path: https://megabonk.org/
          drop-html-extension: true
          # å¦‚æœä½ çš„ GitHub Pages æ˜¯ä» docs/ å‘å¸ƒï¼Œè¯·å–æ¶ˆä¸‹é¢ä¸¤è¡Œæ³¨é‡Šï¼š
          # path-to-root: docs
          # sitemap-path: docs/sitemap.xml


      - name: Commit & rebase, then push
        run: |
          set -euxo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # ä»…åœ¨ç¡®æœ‰å˜æ›´æ—¶æäº¤
          if ! git diff --quiet; then
            git add -A
            git commit -m "ğŸ¤– Update aliases & sitemap [skip ci]"
          else
            echo "No changes to commit."
            exit 0
          fi

          # é¿å… non-fast-forwardï¼šå…ˆåŒæ­¥è¿œç«¯å† rebase
          git fetch origin main
          git rebase origin/main

          # æ¨é€åˆ° mainï¼ˆå¦‚å¯ç”¨åˆ†æ”¯ä¿æŠ¤ï¼Œè¯·æ”¹ç”¨ PR æµç¨‹ï¼‰
          git push origin HEAD:main
