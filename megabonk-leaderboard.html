<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Megabonk Leaderboard</title>
<style>
  :root { color-scheme: dark; }
  body {
    margin:0; padding:24px;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC","Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei", sans-serif;
    background:#0f172a; color:#e5e7eb;
  }
  .container { max-width:1200px; margin:0 auto; }
  h1 { font-size:32px; margin:0 0 16px; font-weight:800; }
  .toolbar {
    display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:16px;
  }
  .input, .select, .btn {
    background:#111827; color:#e5e7eb; border:1px solid #1f2937; border-radius:10px;
    height:40px; padding:0 12px; font-size:14px;
  }
  .btn { cursor:pointer; }
  .pill { padding:4px 10px; border-radius:999px; font-size:12px; background:#111827; border:1px solid #1f2937; }
  .success { background:#065f46; border-color:#064e3b; }
  .danger { background:#7f1d1d; border-color:#641414; }
  .table {
    width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px;
    border:1px solid #1f2937; background:#0b1220;
  }
  .table th, .table td {
    padding:14px 16px; border-bottom:1px solid #1f2937; text-align:left; font-size:14px;
  }
  .table th { color:#9ca3af; font-weight:600; }
  .table tr:hover { background:#0f1a30; }
  .rowlink { color:#93c5fd; text-decoration:none; }
  .muted { color:#9ca3af; }
  .right { text-align:right; }
  .statusLine { display:flex; gap:8px; align-items:center; margin:12px 0; }
  .footer {
    display:flex; justify-content:space-between; align-items:center;
    padding:14px 16px; border:1px solid #1f2937; border-top:none; border-radius:0 0 14px 14px; background:#0b1220;
  }
  /* 详情卡片 */
  .card {
    margin-top:24px; border:1px solid #1f2937; background:#0b1220; border-radius:16px; overflow:hidden;
  }
  .cardHeader {
    display:flex; gap:16px; align-items:center; padding:16px; border-bottom:1px solid #1f2937;
  }
  .avatar { width:56px; height:56px; border-radius:12px; background:#111827; object-fit:contain; }
  .tag { display:inline-block; padding:6px 10px; background:#111827; border:1px solid #1f2937; border-radius:999px; margin-right:8px; font-size:12px; }
  .grid {
    display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:16px;
  }
  .chipRow { display:flex; flex-wrap:wrap; gap:8px; }
  .iconRow { display:flex; flex-wrap:wrap; gap:10px; }
  .iconRow img { width:36px; height:36px; object-fit:contain; background:#0f172a; border-radius:8px; padding:4px; border:1px solid #1f2937; }
  iframe { width:100%; aspect-ratio:16/9; border:0; background:#000; border-radius:12px; }
  .countryBadge {
    display:inline-flex; align-items:center; justify-content:center;
    width:28px; height:28px; border-radius:999px; background:#1f2937; font-size:12px; margin-left:6px;
  }
  .rankBadge { font-weight:800; }
  .downloads a { color:#93c5fd; text-decoration:none; margin-left:8px; }
  .loading { color:#9ca3af; }
  .hidden { display:none !important; }
</style>
</head>
<body>
<div class="container">
  <h1>Megabonk Leaderboard</h1>

  <!-- 工具栏 -->
  <div class="toolbar">
    <select id="patch" class="select">
      <!-- 需要更多补丁可自行追加 -->
      <option value="1.0.17" selected>1.0.17</option>
    </select>

    <input id="search" class="input" style="min-width:320px" placeholder="玩家 / 角色 / 国家代码…" />
    <select id="charFilter" class="select">
      <option value="">全部角色</option>
    </select>

    <button id="refresh" class="btn">刷新</button>

    <span class="pill">数据源：<span id="sourceName" class="muted">（未加载）</span></span>
    <span id="statusPill" class="pill">状态：…</span>
  </div>

  <!-- 状态栏 -->
  <div class="statusLine">
    <span id="summary" class="muted">正在加载…</span>
  </div>

  <!-- 表格 -->
  <table class="table" id="tbl">
    <thead>
      <tr>
        <th style="width:72px;">名次</th>
        <th>玩家</th>
        <th>角色</th>
        <th class="right">击杀</th>
        <th style="width:80px;">视频</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="footer">
    <div class="muted">数据文件位于 <code>/data/leaderboard-&lt;patch&gt;.json</code>（优先）或 <code>.csv</code></div>
    <div class="downloads">
      <a id="dlJson" href="#" download>下载 JSON</a> ·
      <a id="dlCsv" href="#" download>下载 CSV</a>
    </div>
  </div>

  <!-- 详情卡片 -->
  <div id="detail" class="card hidden">
    <div class="cardHeader">
      <img id="detailAvatar" class="avatar" alt="" />
      <div>
        <div style="font-size:18px; font-weight:700;">
          <span id="detailPlayer">—</span>
          <span id="detailCountry" class="countryBadge">--</span>
        </div>
        <div class="chipRow" style="margin-top:8px;">
          <span class="tag rankBadge" id="detailRank">#—</span>
          <span class="tag" id="detailKills">KILLS —</span>
          <span class="tag" id="detailPatch">v—</span>
        </div>
      </div>
    </div>
    <div class="grid">
      <div>
        <div class="muted" style="margin-bottom:6px;">武器</div>
        <div id="weaponIcons" class="iconRow"></div>

        <div class="muted" style="margin:14px 0 6px;">法典</div>
        <div id="tomeIcons" class="iconRow"></div>

        <div class="muted" style="margin:14px 0 6px;">道具</div>
        <div id="itemIcons" class="iconRow"></div>
      </div>
      <div>
        <iframe id="video" allowfullscreen></iframe>
      </div>
    </div>
  </div>

</div>

<script>
/* =======================
   图片回退与别名映射
   ======================= */

// 常见别名（JSON 中的 key → 真实文件名（不含扩展名））
const ASSET_ALIASES = {
  weapon: {
    katana: 'CorruptedSword',
    blackhole: 'Black_Hole',
    bloodmagic: 'Blood_Magic',
    dragonsbreath: 'Dragons_Breath',
    dexecutioner: 'Dexecutioner',
    firestaff: 'Firestaff',
  },
  characters: {
    // 你的仓库暂无 noelle，可临时指到已有的角色立绘（需要时替换为真正的 Noelle）
    noelle: 'Megachad'
  },
  item: {
    // 如需为个别道具做别名，在此补充
  },
  tome: {
    // 如需为法典做别名，在此补充
  }
};

// 将 "blood_magic" / "blood-magic" / "blood magic" → "Blood_Magic"
function toTitleCaseSlug(slug) {
  return (slug || '')
    .toLowerCase()
    .replace(/[-_\s]+/g, ' ')
    .replace(/\b([a-z])/g, (_, c) => c.toUpperCase())
    .replace(/\s+/g, '_');
}

// 生成候选图片路径（默认路径 + 你仓库的现状路径 + 别名）
function buildIconCandidates(kind, key) {
  const slug = (key || '').toLowerCase().trim();
  const title = toTitleCaseSlug(slug);
  const alias = ASSET_ALIASES[kind]?.[slug];

  const candidates = new Set();

  // 默认路径（若你未来把图统一放到 /img 下会先命中）
  candidates.add(`/img/${kind}/${slug}.png`);
  candidates.add(`/img/${kind}/${title}.png`);

  // 当前仓库实际路径
  if (kind === 'weapon') {
    candidates.add(`/images/database/weapons/${title}.png`);
  } else if (kind === 'characters') {
    candidates.add(`/images/guides/characters/${title}.png`);
  } else if (kind === 'item') {
    candidates.add(`/images/database/items/${title}.png`);
  } else if (kind === 'tome') {
    candidates.add(`/images/database/tomes/${title}.png`);
  }

  // 别名
  if (alias) {
    if (kind === 'weapon') candidates.add(`/images/database/weapons/${alias}.png`);
    if (kind === 'characters') candidates.add(`/images/guides/characters/${alias}.png`);
    if (kind === 'item') candidates.add(`/images/database/items/${alias}.png`);
    if (kind === 'tome') candidates.add(`/images/database/tomes/${alias}.png`);
    candidates.add(`/img/${kind}/${alias.toLowerCase()}.png`);
  }

  return Array.from(candidates);
}

// 绑定 <img> 多源回退
function setIcon(img, kind, key) {
  const srcs = buildIconCandidates(kind, key);
  let i = 0;
  img.onerror = () => {
    i++;
    if (i < srcs.length) img.src = srcs[i];
    else img.remove(); // 全部失败则移除占位
  };
  img.src = srcs[i];
}

/* =======================
   工具函数
   ======================= */

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const fmt = (n) => n == null ? '-' : n.toLocaleString('en-US');
const by = (sel, root=document) => root.querySelector(sel);

function getDataUrl(patch) {
  return `/data/leaderboard-${patch}.json`;
}

function toEmbedUrl(url) {
  if (!url) return '';
  try {
    const u = new URL(url);
    if (u.hostname.includes('youtu.be')) {
      // https://youtu.be/<id>
      return `https://www.youtube.com/embed/${u.pathname.slice(1)}`;
    }
    if (u.hostname.includes('youtube.com')) {
      if (u.searchParams.get('v')) {
        return `https://www.youtube.com/embed/${u.searchParams.get('v')}`;
      }
      // shorts
      if (u.pathname.startsWith('/shorts/')) {
        return `https://www.youtube.com/embed/${u.pathname.split('/')[2]}`;
      }
    }
  } catch {}
  return url; // fallback: 直接用
}

function unique(arr) { return Array.from(new Set(arr)); }

/* =======================
   渲染逻辑
   ======================= */

let rawData = [];

function fillCharFilter(data) {
  const sel = $('#charFilter');
  const val = sel.value;
  const options = [''].concat(unique(data.map(r => r.character).filter(Boolean)));
  sel.innerHTML = options.map(c => {
    const txt = c ? c : '全部角色';
    return `<option value="${c}">${txt}</option>`;
  }).join('');
  sel.value = val || '';
}

function renderTable() {
  const tbody = $('#tbody');
  const q = $('#search').value.trim().toLowerCase();
  const char = $('#charFilter').value;

  let data = rawData.slice();
  if (q) {
    data = data.filter(r =>
      (r.player || '').toLowerCase().includes(q) ||
      (r.character || '').toLowerCase().includes(q) ||
      (r.country_code || '').toLowerCase().includes(q)
    );
  }
  if (char) {
    data = data.filter(r => (r.character || '').toLowerCase() === char.toLowerCase());
  }

  tbody.innerHTML = data.map(r => {
    const videoTxt = r.video_url ? '打开' : '-';
    return `
      <tr data-rank="${r.rank}">
        <td>#${r.rank}</td>
        <td>
          <div style="display:flex; align-items:center; gap:8px;">
            <div>${r.player || '-'}</div>
            <div class="countryBadge">${(r.country_code || '--').toUpperCase()}</div>
          </div>
        </td>
        <td><span class="pill">${r.character || '-'}</span> <span class="pill muted">v${r.patch || '-'}</span></td>
        <td class="right">${fmt(r.kills)}</td>
        <td><a class="rowlink" href="${r.video_url || '#'}" target="_blank" rel="noopener">${videoTxt}</a></td>
      </tr>`;
  }).join('');

  // 绑定点击行 -> 展示详情
  $$('#tbody tr').forEach(tr => {
    tr.addEventListener('click', () => {
      const rank = +tr.getAttribute('data-rank');
      const row = rawData.find(r => r.rank === rank);
      if (row) renderDetail(row);
      window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
    });
  });

  const patch = $('#patch').value;
  $('#dlJson').href = getDataUrl(patch);
  $('#dlJson').setAttribute('download', `leaderboard-${patch}.json`);
  $('#dlCsv').href = `/data/leaderboard-${patch}.csv`;
  $('#dlCsv').setAttribute('download', `leaderboard-${patch}.csv`);
}

function renderDetail(row) {
  $('#detail').classList.remove('hidden');

  // 标题区
  $('#detailPlayer').textContent = row.player || '-';
  $('#detailCountry').textContent = (row.country_code || '--').toUpperCase();
  $('#detailRank').textContent = `#${row.rank}`;
  $('#detailKills').textContent = `KILLS ${fmt(row.kills)}`;
  $('#detailPatch').textContent = `v${row.patch || '-'}`;

  // 角色头像
  const avatar = $('#detailAvatar');
  avatar.alt = row.character || '';
  setIcon(avatar, 'characters', row.character || '');

  // 图标区
  const wWrap = $('#weaponIcons'); wWrap.innerHTML = '';
  const tWrap = $('#tomeIcons');   tWrap.innerHTML = '';
  const iWrap = $('#itemIcons');   iWrap.innerHTML = '';

  (row.weapons || []).forEach(w => {
    const im = new Image();
    im.title = w;
    setIcon(im, 'weapon', w);
    wWrap.appendChild(im);
  });

  (row.tomes || []).forEach(t => {
    const im = new Image();
    im.title = t;
    // 有些项目把法典也放在 /img/items 或 /images/database/items
    // 我们先按 tome，再按 item 的候选
    const tryTomeFirst = buildIconCandidates('tome', t);
    const tryItemThen = buildIconCandidates('item', t);
    const img = im;
    let list = [...tryTomeFirst, ...tryItemThen];
    let i = 0;
    img.onerror = () => { if (++i < list.length) img.src = list[i]; else img.remove(); };
    img.src = list[i];
    tWrap.appendChild(img);
  });

  (row.items || []).forEach(it => {
    const im = new Image();
    im.title = it;
    setIcon(im, 'item', it);
    iWrap.appendChild(im);
  });

  // 视频
  by('#video').src = toEmbedUrl(row.video_url || '');
}

/* =======================
   加载数据
   ======================= */

async function load() {
  const patch = $('#patch').value;
  const url = getDataUrl(patch);

  $('#sourceName').textContent = `leaderboard-${patch}.json`;
  $('#statusPill').textContent = '状态：加载中…';
  $('#statusPill').classList.remove('success','danger');
  $('#summary').textContent = '正在加载…';
  $('#detail').classList.add('hidden');
  $('#tbody').innerHTML = '';

  try {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    // 归一化字段，兼容大小写差异
    rawData = (Array.isArray(data) ? data : []).map(x => ({
      rank: x.rank ?? x.Rank,
      player: x.player ?? x.Player ?? '',
      character: (x.character ?? x.Character ?? '').toString().toLowerCase(),
      kills: Number(x.kills ?? x.Kills ?? 0),
      country_code: (x.country_code ?? x.CountryCode ?? x.country ?? '').toString(),
      video_url: x.video_url ?? x.VideoURL ?? x.video ?? '',
      patch: x.patch ?? x.Patch ?? patch,
      weapons: x.weapons ?? x.Weapons ?? [],
      tomes: x.tomes ?? x.Tomes ?? [],
      items: x.items ?? x.Items ?? [],
      created_at_iso: x.created_at_iso ?? x.CreatedAt ?? '',
      updated_at_iso: x.updated_at_iso ?? x.UpdatedAt ?? '',
    }));

    // 填充角色筛选
    fillCharFilter(rawData);
    // 渲染表格
    renderTable();

    const lastUpdated = rawData.reduce((m, r) => m || r.updated_at_iso, '') || '—';
    $('#summary').textContent = `总计 ${rawData.length} 条 · 上次更新 ${lastUpdated.replace('T',' ').replace('Z','')}`;
    $('#statusPill').textContent = '状态：已加载';
    $('#statusPill').classList.add('success');
  } catch (err) {
    console.error(err);
    $('#summary').textContent = '加载失败，请检查数据文件路径或跨域设置。';
    $('#statusPill').textContent = '状态：失败';
    $('#statusPill').classList.add('danger');
  }
}

/* =======================
   事件绑定
   ======================= */

$('#refresh').addEventListener('click', load);
$('#patch').addEventListener('change', load);
$('#search').addEventListener('input', renderTable);
$('#charFilter').addEventListener('change', renderTable);

// 首次加载
load();
</script>
</body>
</html>
