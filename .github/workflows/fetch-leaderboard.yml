
name: 采集 Megabonk 排行榜数据

on:
  schedule:
    # 每5分钟运行一次
    - cron: '*/5 * * * *'
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main ]

jobs:
  fetch-leaderboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 设置 Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: 安装依赖
      run: pip install requests
    
    - name: 采集排行榜数据
      run: |
        python << 'EOF'
        import requests
        import json
        from datetime import datetime
        from pathlib import Path

        API_URL = 'https://megabonk.fun/api/leaderboard'

        print('📡 正在获取数据...')
        response = requests.get(API_URL, timeout=15)
        response.raise_for_status()
        data = response.json()
        
        print(f'✅ 成功获取 {len(data)} 条数据')
        
        # 创建目录
        Path('data').mkdir(exist_ok=True)
        
        # 保存数据
        output = {
            'source': 'megabonk.fun',
            'source_url': API_URL,
            'fetched_at': datetime.utcnow().isoformat() + 'Z',
            'count': len(data),
            'data': data
        }
        
        with open('data/leaderboard.json', 'w', encoding='utf-8') as f:
            json.dump(output, f, ensure_ascii=False, indent=2)
        
        print('💾 数据已保存')
        EOF
    
    - name: 提交数据
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add data/leaderboard.json
        git diff --staged --quiet || git commit -m "🤖 更新排行榜 $(date -u '+%Y-%m-%d %H:%M')"
        git push
