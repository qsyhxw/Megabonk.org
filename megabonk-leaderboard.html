<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Megabonk Leaderboard</title>
<style>
  :root {
    --bg: #0b0f14;
    --panel: #121821;
    --muted: #6b7280;
    --text: #e5e7eb;
    --accent: #60a5fa;
    --line: #1f2937;
    --chip: #0f172a;
    --chip-border: #334155;
    --green: #22c55e;
  }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;}
  .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
  h1 { margin:0 0 16px; font-size: 28px; font-weight: 800; letter-spacing:.3px; }
  .toolbar { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:16px; }
  .toolbar .group { display:flex; gap:8px; align-items:center; }
  .input, select { background:#0b1220; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; outline:none; }
  .input::placeholder{ color:#748096; }
  .btn { background:#111827; color:#e5e7eb; border:1px solid var(--line); border-radius:10px; padding:10px 14px; cursor:pointer; }
  .btn:hover { border-color:#2b374a; background:#0e1624; }
  .pill { display:inline-block; font-size:12px; color:#9aa6b2; background:var(--chip); border:1px solid var(--chip-border); padding:4px 8px; border-radius:99px; }
  .panel { background:var(--panel); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
  .panel-head { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--line); }
  .small { color:var(--muted); font-size:12px; }
  table { width:100%; border-collapse:collapse; }
  thead th { text-align:left; padding:12px 16px; color:#cbd5e1; font-weight:700; border-bottom:1px solid var(--line); background:#0e1520; position:sticky; top:0; z-index:1;}
  tbody td { padding:12px 16px; border-bottom:1px solid var(--line); vertical-align:top; }
  tbody tr:hover { background:rgba(255,255,255,.02); }
  .num { text-align:right; font-variant-numeric: tabular-nums; }
  .muted { color:var(--muted); }
  .link { color:#9bd2ff; text-decoration:none; }
  .link:hover { text-decoration:underline; }
  .flex { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  .right { text-align:right; }
  .foot { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; color:#9aa6b2; }
  .spinner { display:inline-flex; gap:6px; align-items:center; }
  .dot { width:6px; height:6px; border-radius:50%; background:#94a3b8; animation: b 1.2s infinite ease-in-out; }
  .dot:nth-child(2){ animation-delay:.15s } .dot:nth-child(3){ animation-delay:.3s }
  @keyframes b { 0%,80%,100%{ opacity:.2; transform:translateY(0) } 40%{ opacity:1; transform:translateY(-3px) } }
  .badge-green { color:#86efac; border-color:#1e3a2a; background:#0b1f14; }
  .btn-sort { color:#cbd5e1; cursor:pointer; user-select:none; }
  .btn-sort:hover { color:#fff; }
  .sr { border:0; clip:rect(0 0 0 0); clip-path: inset(50%); height:1px; width:1px; margin:-1px; overflow:hidden; padding:0; position:absolute; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Megabonk Leaderboard</h1>

  <!-- 工具栏 -->
  <div class="toolbar">
    <div class="group">
      <label for="patch" class="sr">补丁</label>
      <input id="patch" class="input" style="width:140px" placeholder="补丁（如 1.0.17）" />
    </div>
    <div class="group">
      <label for="q" class="sr">搜索</label>
      <input id="q" class="input" style="width:280px" placeholder="玩家 / 角色 / 国家代码…" />
    </div>
    <div class="group">
      <label for="char" class="sr">角色</label>
      <select id="char">
        <option value="">全部</option>
      </select>
    </div>
    <button id="btn-refresh" class="btn">刷新</button>
    <span class="pill">数据源：<span id="data-source-badge">（未加载）</span></span>
  </div>

  <!-- 列表 -->
  <div class="panel" id="panel">
    <div class="panel-head">
      <div class="flex">
        <span class="small">总计 <b id="stat-count">0</b> 条</span>
        <span class="small">· 上次更新 <span id="stat-last" class="muted">-</span></span>
      </div>
      <div class="small">状态：<span id="status"><span class="spinner"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></span></div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:70px">名次</th>
            <th>玩家</th>
            <th style="width:180px">角色</th>
            <th class="right btn-sort" id="sort-kills" style="width:110px">击杀 ▲▼</th>
            <th style="width:150px">视频</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="muted" style="padding:24px 16px">尚无数据</td></tr>
        </tbody>
      </table>
    </div>

    <div class="foot">
      <div>数据文件位于 <code>/data/leaderboard-&lt;patch&gt;.json</code>（优先）或 <code>.csv</code></div>
      <div class="flex">
        <a id="link-json" class="link" href="#" download>下载 JSON</a> ·
        <a id="link-csv" class="link" href="#" download>下载 CSV</a>
      </div>
    </div>
  </div>
</div>

<script>
  // ---------- 配置 ----------
  const CONFIG = {
    dataDir: '/data/',           // 你的站点在根域名，固定使用根路径
    defaultPatch: '1.0.17',
    PATCHES: ['1.0.17']
  };

  // ---------- 状态 ----------
  const state = {
    rows: [],
    filtered: [],
    sort: { key: 'kills', dir: 'desc' }
  };

  // ---------- 工具 ----------
  const $ = (sel) => document.querySelector(sel);
  const fmt = (n) => n == null ? '' : Number(n).toLocaleString();
  const by = (k, dir='asc') => (a,b) => (a[k]??0) === (b[k]??0) ? 0 : ((a[k]??0) > (b[k]??0) ? 1 : -1) * (dir==='asc'?1:-1);
  const setStatus = (html) => $('#status').innerHTML = html;
  const updateSourceBadge = (text) => $('#data-source-badge').textContent = text;

  // 兼容多种 JSON 外层结构
  function coerceRows(input) {
    let rows = Array.isArray(input) ? input
      : (input?.data || input?.rows || input?.leaderboard || input?.results || input?.list || []);
    if (!Array.isArray(rows)) rows = [];
    // 归一化字段与类型
    return rows.map((r,i) => ({
      rank: num(r.rank ?? i+1),
      player: str(r.player || r.playerName || r.name),
      character: str(r.character),
      kills: num(r.kills),
      country_code: str(r.country_code || r.country || r.countryCode || r.code || '').slice(0,2).toUpperCase(),
      video_url: str(r.video_url || r.videoURL || r.video || ''),
      patch: str(r.patch || ''),
      weapons: arr(r.weapons),
      tomes: arr(r.tomes),
      items: arr(r.items),
      created_at_iso: str(r.created_at_iso || r.createdAt),
      updated_at_iso: str(r.updated_at_iso || r.updatedAt)
    })).filter(x => x.player && x.character);
  }
  const num = (v)=> (v===''||v==null) ? 0 : Number(v);
  const str = (v)=> (v==null) ? '' : String(v);
  const arr = (v)=> Array.isArray(v) ? v : (typeof v==='string' && v ? v.split(/[;,]\s*/).filter(Boolean) : []);

  // CSV 解析（weapons/tomes/items 分号分隔）
  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];
    const head = lines.shift().split(',').map(s=>s.trim());
    const idx = (k)=> head.indexOf(k);
    return lines.map((ln,i)=>{
      const cols = ln.split(',').map(s=>s.trim());
      const get = (k)=> idx(k) >=0 ? cols[idx(k)] : '';
      return {
        rank: num(get('rank') || (i+1)),
        player: get('player'),
        character: get('character'),
        kills: num(get('kills')),
        country_code: (get('country_code')||'').slice(0,2).toUpperCase(),
        video_url: get('video_url'),
        patch: get('patch'),
        weapons: (get('weapons')||'').split(';').filter(Boolean),
        tomes: (get('tomes')||'').split(';').filter(Boolean),
        items: (get('items')||'').split(';').filter(Boolean),
        created_at_iso: get('created_at_iso'),
        updated_at_iso: get('updated_at_iso')
      };
    }).filter(x => x.player && x.character);
  }

  async function fetchData(patch) {
    const base = CONFIG.dataDir + `leaderboard-${patch}`;
    // 先 JSON
    try {
      const r = await fetch(base + '.json', { cache: 'no-store' });
      if (r.ok) {
        updateSourceBadge(`leaderboard-${patch}.json`);
        return coerceRows(await r.json());
      }
    } catch(e) {}
    // 再 CSV
    try {
      const r = await fetch(base + '.csv', { cache: 'no-store' });
      if (r.ok) {
        updateSourceBadge(`leaderboard-${patch}.csv`);
        return parseCSV(await r.text());
      }
    } catch(e) {}
    updateSourceBadge('（未加载）');
    return [];
  }

  function setDownloadLinks(patch) {
    $('#link-json').href = CONFIG.dataDir + `leaderboard-${patch}.json`;
    $('#link-csv').href  = CONFIG.dataDir + `leaderboard-${patch}.csv`;
  }

  // 渲染角色过滤选项（从数据中提取去重）
  function renderCharOptions(rows) {
    const sel = $('#char');
    const cur = sel.value;
    const set = new Set(rows.map(r => r.character).filter(Boolean));
    const list = [''].concat([...set].sort());
    sel.innerHTML = list.map(v => `<option value="${escapeHtml(v)}">${v || '全部'}</option>`).join('');
    if (set.has(cur)) sel.value = cur;
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // 过滤 + 排序 + 渲染
  function applyFilters() {
    const q = ($('#q').value || '').trim().toLowerCase();
    const pickChar = $('#char').value || '';
    let rows = state.rows.slice();

    if (q) {
      rows = rows.filter(r =>
        (r.player||'').toLowerCase().includes(q) ||
        (r.character||'').toLowerCase().includes(q) ||
        (r.country_code||'').toLowerCase().includes(q)
      );
    }
    if (pickChar) rows = rows.filter(r => r.character === pickChar);

    rows.sort(by(state.sort.key, state.sort.dir));
    state.filtered = rows;
    renderTable(rows);
    $('#stat-count').textContent = rows.length;

    // 取最近更新时间
    const last = rows
      .map(r => Date.parse(r.updated_at_iso || r.created_at_iso || 0))
      .filter(n => !isNaN(n))
      .sort((a,b)=>b-a)[0];
    $('#stat-last').textContent = last ? new Date(last).toLocaleString() : '-';
  }

  function renderTable(rows) {
    const tb = $('#tbody');
    if (!rows.length) {
      tb.innerHTML = `<tr><td colspan="5" class="muted" style="padding:24px 16px">没有匹配的结果</td></tr>`;
      return;
    }
    tb.innerHTML = rows.map(r => {
      const flag = r.country_code ? `<span class="pill">${escapeHtml(r.country_code)}</span>` : '';
      const vid = r.video_url ? `<a class="link" href="${escapeHtml(r.video_url)}" target="_blank" rel="noopener">打开</a>` : `<span class="muted">-</span>`;
      return `<tr>
        <td>${fmt(r.rank)}</td>
        <td>${escapeHtml(r.player)} ${flag}</td>
        <td>${escapeHtml(r.character)}</td>
        <td class="num">${fmt(r.kills)}</td>
        <td>${vid}</td>
      </tr>`;
    }).join('');
  }

  // 加载主流程
  async function loadLeaderboard() {
    const patch = ($('#patch').value || '').trim();
    if (!patch) {
      setStatus(`<span class="muted">请输入补丁号后刷新</span>`);
      updateSourceBadge('（未加载）');
      renderTable([]);
      $('#stat-count').textContent = '0';
      $('#stat-last').textContent = '-';
      setDownloadLinks('');
      return;
    }
    setDownloadLinks(patch);
    setStatus(`<span class="spinner"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);
    try {
      const rows = await fetchData(patch);
      state.rows = rows;
      renderCharOptions(rows);
      applyFilters();
      setStatus(`<span class="badge-green pill">已加载</span>`);
    } catch (e) {
      console.error(e);
      state.rows = [];
      applyFilters();
      setStatus(`<span class="muted">加载失败</span>`);
    }
  }

  // 事件
  function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
  $('#btn-refresh').addEventListener('click', loadLeaderboard);
  $('#q').addEventListener('input', debounce(applyFilters, 120));
  $('#char').addEventListener('change', applyFilters);
  $('#sort-kills').addEventListener('click', () => {
    state.sort.dir = (state.sort.key==='kills' && state.sort.dir==='desc') ? 'asc' : 'desc';
    state.sort.key = 'kills';
    applyFilters();
  });

  // 初始化
  document.addEventListener('DOMContentLoaded', () => {
    if (!$('#patch').value) $('#patch').value = CONFIG.defaultPatch;
    loadLeaderboard();
  });
</script>
</body>
</html>
