
name: é‡‡é›† Megabonk æ’è¡Œæ¦œæ•°æ®

on:
  schedule:
    # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/5 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  fetch-leaderboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: å®‰è£…ä¾èµ–
      run: pip install requests
    
    - name: é‡‡é›†æ’è¡Œæ¦œæ•°æ®
      run: |
        python << 'EOF'
        import requests
        import json
        from datetime import datetime
        from pathlib import Path

        API_URL = 'https://megabonk.fun/api/leaderboard'

        print('ğŸ“¡ æ­£åœ¨è·å–æ•°æ®...')
        response = requests.get(API_URL, timeout=15)
        response.raise_for_status()
        data = response.json()
        
        print(f'âœ… æˆåŠŸè·å– {len(data)} æ¡æ•°æ®')
        
        # åˆ›å»ºç›®å½•
        Path('data').mkdir(exist_ok=True)
        
        # ä¿å­˜æ•°æ®
        output = {
            'source': 'megabonk.fun',
            'source_url': API_URL,
            'fetched_at': datetime.utcnow().isoformat() + 'Z',
            'count': len(data),
            'data': data
        }
        
        with open('data/leaderboard.json', 'w', encoding='utf-8') as f:
            json.dump(output, f, ensure_ascii=False, indent=2)
        
        print('ğŸ’¾ æ•°æ®å·²ä¿å­˜')
        EOF
    
    - name: æäº¤æ•°æ®
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add data/leaderboard.json
        git diff --staged --quiet || git commit -m "ğŸ¤– æ›´æ–°æ’è¡Œæ¦œ $(date -u '+%Y-%m-%d %H:%M')"
        git push
