name: Fetch Megabonk Leaderboard

on:
  schedule:
    - cron: '*/180 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  fetch-leaderboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install requests brotli fake-useragent
    
    - name: Fetch leaderboard data
      run: |
        python << 'EOF'
        import requests
        import json
        import time
        import random
        from datetime import datetime
        from pathlib import Path
        try:
            from fake_useragent import UserAgent
            ua = UserAgent()
            user_agent = ua.chrome
        except:
            user_agent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'

        API_URL = 'https://megabonk.fun/api/leaderboard'

        # Complete browser-like headers
        headers = {
            'User-Agent': user_agent,
            'Accept': 'application/json, text/plain, */*',
            'Accept-Language': 'en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7',
            'Accept-Encoding': 'gzip, deflate, br',
            'Referer': 'https://megabonk.fun/',
            'Origin': 'https://megabonk.fun',
            'Connection': 'keep-alive',
            'Sec-Fetch-Dest': 'empty',
            'Sec-Fetch-Mode': 'cors',
            'Sec-Fetch-Site': 'same-origin',
            'sec-ch-ua': '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',
            'sec-ch-ua-mobile': '?0',
            'sec-ch-ua-platform': '"Windows"',
            'DNT': '1',
            'Upgrade-Insecure-Requests': '1',
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
        }

        print('ğŸ“¡ Fetching data from megabonk.fun...')
        print(f'ğŸ”§ User-Agent: {user_agent[:80]}...')
        
        max_retries = 3
        for attempt in range(max_retries):
            try:
                if attempt > 0:
                    # Exponential backoff with jitter
                    wait_time = (2 ** attempt) + random.uniform(0, 2)
                    print(f'â³ Waiting {wait_time:.1f}s before retry...')
                    time.sleep(wait_time)
                
                # Create a session to maintain cookies
                session = requests.Session()
                session.headers.update(headers)
                
                # First, visit the main page to get cookies
                print('ğŸŒ Visiting main page to get cookies...')
                try:
                    main_page = session.get('https://megabonk.fun/', timeout=15)
                    print(f'âœ… Main page status: {main_page.status_code}')
                    time.sleep(random.uniform(1, 2))  # Human-like delay
                except Exception as e:
                    print(f'âš ï¸  Main page visit failed: {e}')
                
                # Now fetch the API
                print('ğŸ“Š Fetching API data...')
                response = session.get(
                    API_URL,
                    timeout=30
                )
                
                print(f'ğŸ“Š Response status: {response.status_code}')
                print(f'ğŸ“¦ Content-Encoding: {response.headers.get("Content-Encoding", "none")}')
                print(f'ğŸ“ Content length: {len(response.content)} bytes')
                
                if response.status_code == 403:
                    print('âš ï¸  403 Forbidden - possible IP blocking')
                    print(f'ğŸ” Response headers: {dict(response.headers)}')
                    if attempt < max_retries - 1:
                        continue
                
                response.raise_for_status()
                
                # Smart parsing: try multiple methods
                data = None
                
                # Method 1: Try direct JSON parsing
                try:
                    print('ğŸ” Method 1: Trying direct JSON parsing...')
                    data = response.json()
                    print(f'âœ… Method 1 succeeded! Parsed {len(data)} entries')
                except Exception as e:
                    print(f'âŒ Method 1 failed: {e}')
                
                # Method 2: Try parsing response.text as JSON
                if data is None:
                    try:
                        print('ğŸ” Method 2: Trying response.text parsing...')
                        data = json.loads(response.text)
                        print(f'âœ… Method 2 succeeded! Parsed {len(data)} entries')
                    except Exception as e:
                        print(f'âŒ Method 2 failed: {e}')
                
                # Method 3: Try decoding raw content
                if data is None:
                    try:
                        print('ğŸ” Method 3: Trying raw content decode...')
                        data = json.loads(response.content.decode('utf-8'))
                        print(f'âœ… Method 3 succeeded! Parsed {len(data)} entries')
                    except Exception as e:
                        print(f'âŒ Method 3 failed: {e}')
                
                if data is None:
                    raise Exception('All parsing methods failed')
                
                print(f'âœ… Successfully got {len(data)} entries')
                
                # Create output directory
                output_dir = Path('data')
                output_dir.mkdir(exist_ok=True)
                
                # Build complete data structure
                output = {
                    'source': 'megabonk.fun',
                    'source_url': API_URL,
                    'fetched_at': datetime.utcnow().isoformat() + 'Z',
                    'count': len(data),
                    'data': data
                }
                
                # Save main file
                with open('data/leaderboard.json', 'w', encoding='utf-8') as f:
                    json.dump(output, f, ensure_ascii=False, indent=2)
                
                # Save minified version
                with open('data/leaderboard.min.json', 'w', encoding='utf-8') as f:
                    json.dump(output, f, ensure_ascii=False, separators=(',', ':'))
                
                print('ğŸ’¾ Data saved successfully')
                print(f'ğŸ“Š Total entries: {len(data)}')
                
                if len(data) > 0:
                    first_entry = data[0]
                    print(f'ğŸ”‘ First entry keys: {list(first_entry.keys())}')
                    
                    # Try to find player name field
                    player_name = (first_entry.get('name') or 
                                 first_entry.get('player') or 
                                 first_entry.get('username') or 
                                 first_entry.get('user') or
                                 'Unknown')
                    score = (first_entry.get('kills') or 
                           first_entry.get('score') or 
                           first_entry.get('points') or 0)
                    print(f'ğŸ‘¤ Top player: {player_name} - {score:,}')
                
                # Success - exit the retry loop
                break
                
            except Exception as e:
                print(f'âŒ Error on attempt {attempt + 1}/{max_retries}: {type(e).__name__}: {e}')
                if attempt == max_retries - 1:
                    print('ğŸš¨ All attempts failed!')
                    print('ğŸ’¡ Possible reasons:')
                    print('   - GitHub Actions IP is blocked')
                    print('   - API requires additional authentication')
                    print('   - Rate limiting in effect')
                    raise
        
        print('âœ¨ Fetch completed successfully')
        EOF
    
    - name: Commit data to repository
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add data/leaderboard.json data/leaderboard.min.json
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes in data, skipping commit"
        else
          git commit -m "ğŸ¤– Update leaderboard $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "âœ… Data updated and pushed to repository"
        fi
    
    - name: Display summary
      run: |
        echo "==================================================="
        echo "âœ… Leaderboard fetch completed"
        echo "ğŸ“… Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ“ Data location: data/leaderboard.json"
        echo "==================================================="
