<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Megabonk Leaderboard</title>
<style>
  :root{--bg:#0f1825;--card:#122034;--muted:#9fb3c8;--accent:#18b77e;--chip:#0e263c;}
  body{margin:0;background:var(--bg);color:#e6f0ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','PingFang SC','Hiragino Sans GB','Microsoft YaHei',Arial,sans-serif}
  .wrap{max-width:1200px;margin-inline:auto;padding:20px}
  h1{margin:0 0 18px;font-size:32px}
  .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:14px}
  .pill{background:#0e263c;border:1px solid #21364d;border-radius:10px;padding:10px 12px}
  .btn{background:#18324a;border:1px solid #33506f;border-radius:10px;padding:10px 14px;color:#fff;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .status{margin-left:auto}
  .card{background:var(--card);border:1px solid #233b58;border-radius:16px;padding:18px;margin-top:16px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:14px;border-bottom:1px solid #203552}
  th{color:#aecdff;text-align:left}
  .rank{font-weight:700}
  .muted{color:var(--muted)}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #264663;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:8px}
  .flag{width:18px;height:14px;object-fit:cover;border-radius:2px;border:1px solid #2a4764}
  .row{display:grid;grid-template-columns:1fr 460px;gap:18px}
  .icons{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 2px}
  .icon{width:42px;height:42px;display:inline-flex;align-items:center;justify-content:center;background:#0c1f33;border:1px solid #244462;border-radius:8px;overflow:hidden}
  .icon img{width:100%;height:100%;object-fit:contain}
  .icon span{font-size:11px;color:#8fb1d0;padding:0 6px;text-align:center}
  .video{aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0e263c;border:1px solid #2b4b6a;border-radius:6px;padding:2px 6px;font-size:12px;color:#b8d2ee}
</style>
</head>
<body>
<div class="wrap">
  <h1>Megabonk Leaderboard</h1>

  <div class="toolbar">
    <div class="pill muted">数据源：<span id="dataSource" class="kbd">leaderboard-1.0.17.json</span></div>
    <button id="refreshBtn" class="btn">刷新</button>
    <div class="pill status">状态：<span id="status" class="kbd">加载中</span></div>
  </div>

  <!-- 汇总条 -->
  <div id="summary" class="muted" style="margin:6px 0 10px;"></div>

  <!-- 排行表 -->
  <div class="card">
    <table id="tbl">
      <thead>
        <tr>
          <th>名次</th>
          <th>玩家</th>
          <th>角色</th>
          <th>击杀</th>
          <th>视频</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- 选中详情 -->
  <div id="detail" class="card" style="display:none;"></div>

  <div class="muted" style="margin-top:14px">
    数据文件位于 <span class="kbd">/data/leaderboard-&lt;patch&gt;.json</span>（优先）或 <span class="kbd">.csv</span>
  </div>
</div>

<script>
/* ------------------ 工具：命名与路径候选 ------------------ */

// 转 PascalCase（含可选下划线）
function toPascalCase(str){
  if(!str) return '';
  // 先按非字母分割；若是纯小写粘连，则按词典再拆（尽量简单）
  const parts = str
    .replace(/[-\s]+/g,'_')
    .split(/[_/]+/)
    .filter(Boolean);

  if(parts.length===1){
    // 尝试把诸如 bloodmagic → Blood_Magic
    const guess = parts[0]
      .replace(/([a-z])(\d)/g,'$1_$2')
      .replace(/([a-z])(fire|magic|staff|card|glove|doll|tome|ring)/gi,'$1_$2'); // 适度插入
    return guess.split('_').map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join('_');
  }
  return parts.map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join('_');
}

// Tome 名称映射（左侧是 JSON 值）
const TOME_FILE = {
  chaos: 'Chaos_Tome',
  precision: 'Precision_Tome',
  cursed: 'Cursed_Tome',
  cooldown: 'Cooldown_Tome',
  damage: 'Damage_Tome',
  duration: 'Duration_Tome',
  evasion: 'Evasion_Tome',
  health: 'Health_Tome',
  golden: 'Golden_Tome',
  luck: 'Luck_Tome',
  // 你的 JSON 里是“xp”，你资源里没有 XP_Tome，我把它指到 Golden_Tome（可按需改）
  xp: 'Golden_Tome'
};

// 生成一个带回退的 <img> 列表候选
function imageCandidates(kind, key){
  const k = (key||'').trim();
  const pascal = toPascalCase(k).replace(/__/g,'_');       // e.g. bloodmagic → Blood_Magic
  const title = pascal.replace(/_/g,'');                   // 去下划线版本

  const list = [];

  if(kind==='character'){
    // /images/guides/characters/Noelle.png → 回退 /img/characters/noelle.png
    list.push(`/images/guides/characters/${pascal}.png`);
    list.push(`/images/guides/characters/${title}.png`);
    list.push(`/img/characters/${k.toLowerCase()}.png`);
  }else if(kind==='weapon'){
    // 先 database，再普通目录，再旧站路径
    list.push(`/images/database/weapons/${pascal}.png`);
    list.push(`/images/database/weapons/${title}.png`);
    list.push(`/images/weapons/${pascal}.png`);
    list.push(`/images/weapons/${title}.png`);
    list.push(`/img/weapon/${k.toLowerCase()}.png`);
  }else if(kind==='tome'){
    const base = TOME_FILE[k.toLowerCase()] || pascal; // Chaos_Tome 等
    list.push(`/images/Tomes/${base}.png`);
    list.push(`/images/Tomes/${base.replace(/_Tome$/,'_Tome')}.png`);
    list.push(`/img/tome/${k.toLowerCase()}.png`);
  }else if(kind==='item'){
    // 你没给固定目录，这里多路径回退
    list.push(`/images/Items/${pascal}.png`);
    list.push(`/images/Items/${title}.png`);
    list.push(`/images/database/items/${pascal}.png`);
    list.push(`/images/database/items/${title}.png`);
    list.push(`/img/items/${k.toLowerCase()}.png`);
  }

  // 去重
  return Array.from(new Set(list));
}

// 生成“带回退”的 IMG 元素
function iconWithFallback(kind, key, label){
  const cands = imageCandidates(kind, key);
  const box = document.createElement('div');
  box.className = 'icon';

  if(!cands.length){
    const span = document.createElement('span');
    span.textContent = label || key;
    box.append(span);
    return box;
  }

  let idx = 0;
  const img = new Image();
  img.alt = label || key;
  img.src = cands[idx];

  img.onerror = () => {
    idx++;
    if(idx < cands.length){
      img.src = cands[idx];
    }else{
      // 最终失败，回退为文字
      box.innerHTML = '';
      const span = document.createElement('span');
      span.textContent = label || key;
      box.append(span);
    }
  };

  box.append(img);
  return box;
}

/* ------------------ 业务：渲染 ------------------ */

const PATCH = '1.0.17';
const DATA_URL = `/data/leaderboard-${PATCH}.json`;

const $status  = document.getElementById('status');
const $source  = document.getElementById('dataSource');
const $tbody   = document.getElementById('tbody');
const $detail  = document.getElementById('detail');
const $summary = document.getElementById('summary');
document.getElementById('refreshBtn').onclick = load;

$source.textContent = `leaderboard-${PATCH}.json`;

async function load(){
  $status.textContent = '加载中…';
  $tbody.innerHTML = '';
  $detail.style.display = 'none';
  try{
    const res = await fetch(DATA_URL, {cache:'no-store'});
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    const rows = await res.json();

    // 顶部汇总
    const total = rows.length;
    // 使用第一条的时间作“上次更新时间”展示
    const updated = rows[0]?.updated_at_iso || rows[0]?.created_at_iso;
    const localTime = updated ? new Date(updated).toLocaleString() : '—';
    $summary.innerHTML = `总计 <b>${total}</b> 条 · 上次更新 <span class="kbd">${localTime}</span>`;

    // 渲染表格
    for(const r of rows){
      const tr = document.createElement('tr');

      // 名次
      const tdRank = document.createElement('td');
      tdRank.className = 'rank';
      tdRank.textContent = r.rank;
      tr.append(tdRank);

      // 玩家（含国旗）
      const tdPlayer = document.createElement('td');
      const flag = document.createElement('img');
      flag.className = 'flag';
      if(r.country_code){
        flag.src = `https://flagcdn.com/24x18/${String(r.country_code).toLowerCase()}.png`;
        flag.alt = r.country_code;
      }
      const name = document.createElement('span');
      name.style.marginLeft = '8px';
      name.textContent = r.player || 'Unknown';
      tdPlayer.append(flag, name);
      tr.append(tdPlayer);

      // 角色 + patch
      const tdChar = document.createElement('td');
      const chipC = document.createElement('span');
      chipC.className = 'chip';
      chipC.textContent = (r.character || '').toLowerCase();
      const chipP = document.createElement('span');
      chipP.className = 'chip';
      chipP.textContent = `v${r.patch || PATCH}`;
      tdChar.append(chipC, chipP);
      tr.append(tdChar);

      // 击杀
      const tdKills = document.createElement('td');
      tdKills.textContent = Number(r.kills||0).toLocaleString();
      tr.append(tdKills);

      // 视频
      const tdVid = document.createElement('td');
      const a = document.createElement('a');
      a.href = r.video_url || '#';
      a.target = '_blank';
      a.rel = 'noopener';
      a.textContent = r.video_url ? '打开' : '—';
      tdVid.append(a);
      tr.append(tdVid);

      // 点击展开详情
      tr.style.cursor='pointer';
      tr.onclick = () => showDetail(r);
      $tbody.append(tr);
    }

    $status.textContent = '已加载';
  }catch(err){
    console.error(err);
    $status.textContent = '失败';
    $tbody.innerHTML = `<tr><td colspan="5" class="muted">加载失败：${err.message}</td></tr>`;
  }
}

function showDetail(r){
  $detail.style.display = '';
  $detail.innerHTML = ''; // reset

  const row = document.createElement('div');
  row.className = 'row';

  // 左侧信息
  const left = document.createElement('div');

  // 玩家 + 国旗 + 标签
  const title = document.createElement('div');
  title.style.display='flex';
  title.style.gap='10px';
  title.style.alignItems='center';
  title.style.marginBottom='6px';

  const h2 = document.createElement('h2');
  h2.style.margin='0';
  h2.textContent = r.player || 'Unknown';

  const cf = document.createElement('img');
  cf.className='flag';
  if(r.country_code){
    cf.src = `https://flagcdn.com/24x18/${String(r.country_code).toLowerCase()}.png`;
    cf.alt = r.country_code;
  }

  const chips = document.createElement('div');
  const chRank = document.createElement('span'); chRank.className='chip'; chRank.textContent = '#'+(r.rank||'?');
  const chKills= document.createElement('span'); chKills.className='chip'; chKills.textContent = 'KILLS '+Number(r.kills||0).toLocaleString();
  const chPatch= document.createElement('span'); chPatch.className='chip'; chPatch.textContent = 'v'+(r.patch || PATCH);
  chips.append(chRank,chKills,chPatch);

  title.append(h2,cf,chips);
  left.append(title);

  // 角色图标
  const charWrap = document.createElement('div');
  charWrap.className = 'icons';
  charWrap.append(iconWithFallback('character', r.character, r.character));
  left.append(charWrap);

  // 武器
  left.append(label('武器'));
  const wBox = document.createElement('div'); wBox.className='icons';
  (r.weapons||[]).forEach(w=>{
    wBox.append(iconWithFallback('weapon', w, w));
  });
  left.append(wBox);

  // 法典 / Tomes
  left.append(label('法典'));
  const tBox = document.createElement('div'); tBox.className='icons';
  (r.tomes||[]).forEach(t=>{
    tBox.append(iconWithFallback('tome', t, t));
  });
  left.append(tBox);

  // 道具 / Items
  left.append(label('道具'));
  const iBox = document.createElement('div'); iBox.className='icons';
  (r.items||[]).forEach(it=>{
    iBox.append(iconWithFallback('item', it, it));
  });
  left.append(iBox);

  // 右侧视频
  const right = document.createElement('div');
  if(r.video_url){
    right.innerHTML = `<iframe class="video" src="${toEmbed(r.video_url)}" frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;
  }else{
    right.innerHTML = `<div class="video"></div>`;
  }

  row.append(left,right);
  $detail.append(row);
}

function label(text){
  const d = document.createElement('div');
  d.className='muted';
  d.style.marginTop='10px';
  d.textContent = text;
  return d;
}

// 将常见视频链接转换为可嵌入
function toEmbed(url){
  try{
    const u = new URL(url);
    if(u.hostname.includes('youtube.com') || u.hostname==='youtu.be'){
      let id = '';
      if(u.hostname==='youtu.be'){ id = u.pathname.slice(1); }
      else if(u.searchParams.get('v')){ id = u.searchParams.get('v'); }
      return `https://www.youtube.com/embed/${id}`;
    }
    if(u.hostname.includes('twitch.tv')){
      // 用普通外链在新窗口打开；嵌入需要注册 domain，保留外链
      return `about:blank`; // 这里仍显示黑框；点击表格“打开”去新窗播放
    }
    return url;
  }catch{ return url; }
}

/* ------------------ 启动 ------------------ */
load();

</script>
</body>
</html>
