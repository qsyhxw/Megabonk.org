name: Fetch Megabonk Leaderboard

on:
  schedule:
    - cron: '*/180 * * * *'  # Every 30 minutes
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  fetch-leaderboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing cloudscraper for Cloudflare bypass..."
        pip install cloudscraper
        echo "âœ… Installation complete"
    
    - name: Fetch leaderboard data
      run: |
        python << 'EOF'
        import cloudscraper
        import json
        import time
        from datetime import datetime
        from pathlib import Path

        API_URL = 'https://megabonk.fun/api/leaderboard'

        print('ğŸ“¡ Fetching data from megabonk.fun...')
        print('ğŸ›¡ï¸  Using cloudscraper to bypass Cloudflare challenge...')
        
        max_retries = 3
        for attempt in range(max_retries):
            try:
                if attempt > 0:
                    wait_time = attempt * 3
                    print(f'â³ Waiting {wait_time}s before retry...')
                    time.sleep(wait_time)
                
                # Create cloudscraper instance (handles Cloudflare automatically)
                scraper = cloudscraper.create_scraper(
                    browser={
                        'browser': 'chrome',
                        'platform': 'windows',
                        'desktop': True
                    }
                )
                
                print('ğŸŒ Sending request...')
                response = scraper.get(API_URL, timeout=30)
                
                print(f'ğŸ“Š Response status: {response.status_code}')
                print(f'ğŸ“ Content length: {len(response.content)} bytes')
                
                if response.status_code != 200:
                    print(f'âš ï¸  Non-200 status code: {response.status_code}')
                    print(f'ğŸ” Response headers: {dict(response.headers)}')
                    if attempt < max_retries - 1:
                        continue
                
                response.raise_for_status()
                
                # Parse JSON
                data = None
                
                # Method 1: Direct JSON parsing
                try:
                    print('ğŸ” Parsing JSON...')
                    data = response.json()
                    print(f'âœ… Successfully parsed {len(data)} entries')
                except Exception as e:
                    print(f'âŒ JSON parsing failed: {e}')
                    print(f'ğŸ“ First 500 chars of response: {response.text[:500]}')
                    
                    # Method 2: Try manual parsing
                    try:
                        data = json.loads(response.text)
                        print(f'âœ… Manual parsing succeeded! {len(data)} entries')
                    except Exception as e2:
                        print(f'âŒ Manual parsing also failed: {e2}')
                        if attempt < max_retries - 1:
                            continue
                        raise
                
                if data is None or not isinstance(data, list):
                    raise Exception(f'Invalid data format. Got: {type(data)}')
                
                print(f'âœ… Successfully got {len(data)} entries')
                
                # Create output directory
                output_dir = Path('data')
                output_dir.mkdir(exist_ok=True)
                
                # Build complete data structure
                output = {
                    'source': 'megabonk.fun',
                    'source_url': API_URL,
                    'fetched_at': datetime.utcnow().isoformat() + 'Z',
                    'count': len(data),
                    'data': data
                }
                
                # Save main file
                with open('data/leaderboard.json', 'w', encoding='utf-8') as f:
                    json.dump(output, f, ensure_ascii=False, indent=2)
                
                # Save minified version
                with open('data/leaderboard.min.json', 'w', encoding='utf-8') as f:
                    json.dump(output, f, ensure_ascii=False, separators=(',', ':'))
                
                print('ğŸ’¾ Data saved successfully')
                print(f'ğŸ“Š Total entries: {len(data)}')
                
                if len(data) > 0:
                    first_entry = data[0]
                    print(f'ğŸ”‘ First entry keys: {list(first_entry.keys())}')
                    
                    # Try to find player name field
                    player_name = (first_entry.get('name') or 
                                 first_entry.get('player') or 
                                 first_entry.get('username') or 
                                 first_entry.get('user') or
                                 'Unknown')
                    score = (first_entry.get('kills') or 
                           first_entry.get('score') or 
                           first_entry.get('points') or 0)
                    print(f'ğŸ‘¤ Top player: {player_name} - {score:,}')
                    print(f'ğŸ¥‡ First entry: {first_entry}')
                
                # Success - exit the retry loop
                break
                
            except Exception as e:
                print(f'âŒ Error on attempt {attempt + 1}/{max_retries}: {type(e).__name__}: {e}')
                if attempt == max_retries - 1:
                    print('ğŸš¨ All attempts failed!')
                    raise
        
        print('âœ¨ Fetch completed successfully')
        EOF
    
    - name: Commit data to repository
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add data/leaderboard.json data/leaderboard.min.json
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes in data, skipping commit"
        else
          git commit -m "ğŸ¤– Update leaderboard $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "âœ… Data updated and pushed to repository"
        fi
    
    - name: Display summary
      run: |
        echo "==================================================="
        echo "âœ… Leaderboard fetch completed"
        echo "ğŸ“… Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ“ Data location: data/leaderboard.json"
        echo "==================================================="
