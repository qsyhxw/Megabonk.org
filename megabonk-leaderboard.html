<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Megabonk Leaderboard</title>
<style>
  :root{
    --bg:#0b1420;
    --card:#0f1b2a;
    --muted:#7d8b9b;
    --text:#e7f0fb;
    --text-weak:#a8b3c2;
    --primary:#1f6feb;
    --chip:#13253a;
    --ok:#14532d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  }
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .select,.input,.btn{
    height:36px;padding:0 12px;border:1px solid #213246;border-radius:10px;
    background:#0f2033;color:var(--text);outline:none
  }
  .btn{cursor:pointer;background:#113250}
  .hint{color:var(--text-weak);font-size:14px}

  /* 表格区域 */
  .table{margin-top:12px;border-radius:16px;overflow:hidden;background:var(--card);border:1px solid #1a2a3f}
  .thead,.tr{display:grid;grid-template-columns:80px 1fr 160px 160px 120px;align-items:center}
  .thead{padding:14px 18px;background:#0f2033;color:var(--text-weak);font-weight:600}
  .tr{padding:14px 18px;border-top:1px solid #18283a}
  .tr:hover{background:#0d1c2b}
  .status{margin-left:auto}
  .state-chip{background:var(--ok);color:#c6f6d5;border-radius:999px;padding:6px 10px;font-size:12px}

  /* 展开卡片 */
  .detail{grid-column:1/-1;padding:18px;border-top:1px dashed #20364f;background:#0b1a2a}
  .top{display:flex;gap:18px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .avatar{width:52px;height:52px;border-radius:12px;background:#0e2030;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid #1a2a3f}
  .avatar img{width:100%;height:100%;object-fit:contain}
  .tag{display:inline-flex;align-items:center;gap:6px;height:28px;padding:0 10px;border-radius:999px;background:#122233;color:#cfe0f8;font-size:12px;border:1px solid #1e3148}
  .big-number{font-size:18px;font-weight:700}

  .section{margin-top:12px}
  .section h4{margin:0 0 8px 0;color:var(--text-weak);font-size:14px}
  .icons{display:flex;gap:12px;flex-wrap:wrap}
  .icon{
    width:56px;height:56px;border-radius:12px;background:#0e2030;border:1px solid #18283a;
    display:flex;align-items:center;justify-content:center;overflow:hidden
  }
  .icon img{width:100%;height:100%;object-fit:contain}
  .pill{padding:8px 10px;border-radius:999px;background:#0e2030;border:1px solid #1a2a3f;color:#9fb0c5;font-size:12px}

  .flag{font-size:18px}
  .player{display:flex;gap:8px;align-items:center;overflow:hidden}
  .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .link{color:#8ab4ff;text-decoration:underline}
  .right{text-align:right}
</style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 10px 0">Megabonk Leaderboard</h1>

    <div class="row">
      <select id="patch" class="select">
        <option value="1.0.17">1.0.17</option>
      </select>
      <input id="q" class="input" style="min-width:260px" placeholder="玩家 / 角色 / 国家代码..." />
      <select id="charFilter" class="select">
        <option value="">全部角色</option>
      </select>
      <button id="refresh" class="btn">刷新</button>

      <span class="hint" id="meta" style="margin-left:auto"></span>
      <span class="state-chip">已加载</span>
    </div>

    <div class="row" style="margin-top:8px">
      <span class="hint">数据文件位于 <code>/data/leaderboard-&lt;patch&gt;.json</code></span>
      <a class="link" id="dlJson" href="#" download style="margin-left:auto">下载 JSON</a>
    </div>

    <div id="list" class="table"></div>
  </div>

<script>
/** ---------------------- 工具函数 ---------------------- */
const $ = sel => document.querySelector(sel);
const fmt = n => n.toLocaleString('en-US');
const flag = cc => {
  if(!cc) return '';
  const up = cc.toUpperCase();
  // 国旗 emoji（某些系统可能显示为地区字母）
  return String.fromCodePoint(...[...up].map(c=>0x1F1E6 + (c.charCodeAt(0)-65)));
};
const toPascal = (s) => s.replace(/[^a-z0-9]+/gi,' ')
  .trim()
  .split(/\s+/)
  .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
  .join('_');

/** ---------------------- 图片路径映射 ---------------------- */
/* 角色：/images/guides/characters/<Name>.png （首字母大写） */
const characterImg = (name) => `/images/guides/characters/${toPascal(name)}.png`;

/* 武器：/images/weapons/<Name>.png  */
const WEAPON_ALIAS = {
  frostwalker:'Frostwalker', flamewalker:'Flamewalker', axe:'Axe', katana:'Katana', aura:'Aura',
  bomb:'Bomb', wrench:'Wrench', key:'Key'
};
const weaponImg = (id) => `/images/weapons/${(WEAPON_ALIAS[id] || toPascal(id))}.png`;

/* 法典（Tomes）：/images/Tomes/<Name>_Tome.png
   其中 xp → Golden_Tome 映射 */
const TOME_ALIAS = {
  xp:'Golden', chaos:'Chaos', precision:'Precision', cursed:'Cursed',
  agility:'Agility', armor:'Armor', attraction:'Attraction', health:'Health',
  luck:'Luck', cooldown:'Cooldown', duration:'Duration', evasion:'Evasion',
  knockback:'Knockback', damage:'Damage', projectile_speed:'Projectile_Speed', bloody:'Bloody'
};
const tomeImg = (id) => {
  const key = (TOME_ALIAS[id] || toPascal(id)).replace(/_Tome$/,'');
  return `/images/Tomes/${key}_Tome.png`;
};

/* 道具 Items：/images/items/<Name>.png
   这里列了常见别名；若找不到会回退成文字 pill */
const ITEM_ALIAS = {
  curseddoll:'Cursed_Doll',
  cursed_doll:'Cursed_Doll',
  creditcardgreen:'Credit_Card_Green',
  credit_card_green:'Credit_Card_Green',
  key:'Key',
  goldenglove:'Golden_Glove',
  golden_glove:'Golden_Glove',
  wrench:'Wrench',
  mirror:'Mirror',
  chonkplate:'Chonk_Plate',
  unstabletransfusion:'Unstable_Transfusion',
  forbiddenjuice:'Forbidden_Juice',
  brassknuckles:'Brass_Knuckles'
};
const itemImg = (id) => `/images/items/${(ITEM_ALIAS[id] || toPascal(id))}.png`;

/** 创建一个图标方块，加载失败时自动回退为文字 pill */
function createIcon(src, alt){
  const box = document.createElement('div');
  box.className = 'icon';
  const img = new Image();
  img.alt = alt || '';
  img.src = src;
  img.addEventListener('error', ()=>{ box.innerHTML = `<span class="pill">${alt || 'N/A'}</span>`; });
  box.appendChild(img);
  return box;
}

/** ---------------------- 渲染 ---------------------- */
const state = {
  data: [],
  filtered: []
};

async function load(){
  const patch = $('#patch').value;
  const url = `/data/leaderboard-${patch}.json`;
  $('#dlJson').href = url;

  const res = await fetch(url, {cache:'no-store'});
  const data = await res.json();

  // 角色下拉
  const chars = [...new Set(data.map(r => r.character))].sort();
  const sel = $('#charFilter');
  sel.innerHTML = '<option value="">全部角色</option>' + chars.map(c => `<option value="${c}">${c}</option>`).join('');

  state.data = data.sort((a,b)=> (b.kills||0) - (a.kills||0));
  render();
}

function render(){
  const q = $('#q').value.trim().toLowerCase();
  const cf = $('#charFilter').value;
  const list = $('#list'); list.innerHTML = '';

  const arr = state.data.filter(r => {
    const okChar = !cf || r.character === cf;
    const text = [r.player, r.character, r.country_code, r.patch].join(' ').toLowerCase();
    const okQ = !q || text.includes(q);
    return okChar && okQ;
  });

  $('#meta').textContent = `总计 ${arr.length} 条 · 上次更新 ${new Date().toISOString().slice(0,10)} 08:00:00`;

  // 表头
  const thead = document.createElement('div');
  thead.className = 'thead';
  thead.innerHTML = `
    <div>名次</div>
    <div>玩家</div>
    <div>角色</div>
    <div>击杀</div>
    <div class="right">视频</div>
  `;
  list.appendChild(thead);

  arr.forEach((r, idx) => {
    const tr = document.createElement('div');
    tr.className = 'tr';

    // 名次
    const c1 = document.createElement('div');
    c1.innerHTML = `<span class="pill">#${r.rank ?? (idx+1)}</span>`;
    tr.appendChild(c1);

    // 玩家
    const c2 = document.createElement('div');
    c2.className = 'player';
    c2.innerHTML = `
      <span class="flag">${flag(r.country_code)}</span>
      <span class="name">${r.player || '--'}</span>
    `;
    tr.appendChild(c2);

    // 角色
    const c3 = document.createElement('div');
    c3.innerHTML = `<span class="pill">${r.character}</span> <span class="pill">v${r.patch}</span>`;
    tr.appendChild(c3);

    // 击杀
    const c4 = document.createElement('div');
    c4.innerHTML = `<span class="big-number">${fmt(r.kills || 0)}</span>`;
    tr.appendChild(c4);

    // 视频
    const c5 = document.createElement('div');
    c5.className = 'right';
    c5.innerHTML = r.video_url ? `<a class="link" href="${r.video_url}" target="_blank" rel="noreferrer">打开</a>` : '<span class="hint">-</span>';
    tr.appendChild(c5);

    // 展开区
    const detail = document.createElement('div');
    detail.className = 'detail'; detail.hidden = true;

    // 顶部
    const top = document.createElement('div'); top.className = 'top';
    const av = document.createElement('div'); av.className = 'avatar';
    av.appendChild(createIcon(characterImg(r.character), r.character));
    top.appendChild(av);
    const tags = document.createElement('div');
    tags.innerHTML = `
      <span class="tag">#${r.rank ?? (idx+1)}</span>
      <span class="tag">KILLS ${fmt(r.kills||0)}</span>
      <span class="tag">v${r.patch}</span>
    `;
    top.appendChild(tags);
    detail.appendChild(top);

    // 武器
    const wSec = document.createElement('div'); wSec.className='section';
    wSec.innerHTML = `<h4>武器</h4>`;
    const wBox = document.createElement('div'); wBox.className='icons';
    (r.weapons||[]).forEach(id => wBox.appendChild(createIcon(weaponImg(id), id)));
    wSec.appendChild(wBox); detail.appendChild(wSec);

    // 法典
    const tSec = document.createElement('div'); tSec.className='section';
    tSec.innerHTML = `<h4>法典</h4>`;
    const tBox = document.createElement('div'); tBox.className='icons';
    (r.tomes||[]).forEach(id => tBox.appendChild(createIcon(tomeImg(id), id)));
    tSec.appendChild(tBox); detail.appendChild(tSec);

    // 道具
    const iSec = document.createElement('div'); iSec.className='section';
    iSec.innerHTML = `<h4>道具</h4>`;
    const iBox = document.createElement('div'); iBox.className='icons';
    (r.items||[]).forEach(id => iBox.appendChild(createIcon(itemImg(id), id)));
    iSec.appendChild(iBox); detail.appendChild(iSec);

    // 点击展开/收起
    tr.addEventListener('click', () => { detail.hidden = !detail.hidden; });

    list.appendChild(tr);
    list.appendChild(detail);
  });
}

$('#refresh').addEventListener('click', load);
$('#patch').addEventListener('change', load);
$('#q').addEventListener('input', render);
$('#charFilter').addEventListener('change', render);

// 首次加载
load();
</script>
</body>
</html>
